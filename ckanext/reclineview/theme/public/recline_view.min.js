this.ckan.module("recline_view",function(e,i){return{options:{i18n:{errorLoadingPreview:"Could not load view",errorDataProxy:"DataProxy returned an error",errorDataStore:"DataStore returned an error",previewNotAvailableForDataType:"View not available for data type: "},site_url:"",controlsClassName:"controls"},initialize:function(){e.proxyAll(this,/_on/),this.options.resource=JSON.parse(this.options.resource),this.options.resourceView=JSON.parse(this.options.resourceView),this.el.ready(this._onReady),L.Icon.Default.imagePath=this.options.site_url+"vendor/leaflet/0.7.3/images"},_onReady:function(){var e=this.options.resource,i=this.options.resourceView;this.loadView(e,i)},loadView:function(r,t){function o(e){e=e||i("error loading view"),window.parent.ckan.pubsub.publish("data-viewer-error",e)}var n=this;if(""===r.formatNormalized){var a=r.url.split("/");a=a[a.length-1],a=a.split("?"),a=a[0];var l=a.split(".");l.length>1&&(r.formatNormalized=l[l.length-1])}var s,d,p;r.datastore_active?(r.backend="ckan",r.endpoint=e("body").data("site-root")+"api"):(recline.Backend.DataProxy.timeout=1e4,r.backend="dataproxy"),d=new recline.Model.Dataset(r),p=this.options.map_config;var w=new recline.Model.Query;w.set({size:t.limit||100}),w.set({from:t.offset||0});try{if(window.parent.ckan.views&&window.parent.ckan.views.filters){var c=t.filters||{},u=window.parent.ckan.views.filters.get(),v=$.extend({},c,u);$.each(v,function(e,i){w.addFilter({type:"term",field:e,term:i})})}}catch(m){}d.queryState.set(w.toJSON(),{silent:!0}),s=this.options.i18n.errorLoadingPreview+": ","ckan"==r.backend?s+=this.options.i18n.errorDataStore:"dataproxy"==r.backend&&(s+=this.options.i18n.errorDataProxy),d.fetch().done(function(e){n.initializeView(e,t)}).fail(function(e){e.message&&(s+=" ("+e.message+")"),o(s)})},initializeView:function(e,i){var r,t,o=[];if("recline_graph_view"===i.view_type?(t={graphType:i.graph_type,group:i.group,series:[i.series]},r=new recline.View.Graph({model:e,state:t})):"recline_map_view"===i.view_type?(t={geomField:null,latField:null,lonField:null,autoZoom:Boolean(i.auto_zoom),cluster:Boolean(i.cluster_markers)},"geojson"===i.map_field_type?t.geomField=i.geojson_field:(t.latField=i.latitude_field,t.lonField=i.longitude_field),r=new ckan.MapView({model:e,state:t,mapConfig:map_config})):"recline_view"===i.view_type?r=this._newDataExplorer(e,this.options.map_config):(r=new recline.View.SlickGrid({model:e}),o=[new recline.View.Pager({model:r.model}),new recline.View.RecordCount({model:e}),new recline.View.QueryEditor({model:r.model.queryState})]),"recline_view"!==i.view_type){var n=$("<div />");this._renderControls(n,o,this.options.controlsClassName),n.append(r.el),$(this.el).html(n),r.visible=!0,r.render()}"recline_graph_view"===i.view_type&&r.redraw()},_newDataExplorer:function(e,i){var r=[{id:"grid",label:"Grid",view:new recline.View.SlickGrid({model:e})},{id:"graph",label:"Graph",view:new recline.View.Graph({model:e})},{id:"map",label:"Map",view:new ckan.MapView({model:e,mapConfig:i})}],t=[{id:"valueFilter",label:"Filters",view:new recline.View.ValueFilter({model:e})}],o=new recline.View.MultiView({el:this.el,model:e,views:r,sidebarViews:t,config:{readOnly:!0}});return o},_renderControls:function(e,i,r){for(var t=$('<div class="clearfix '+r+'" />'),o=0;o<i.length;o++)t.append(i[o].el);$(e).append(t)}}});